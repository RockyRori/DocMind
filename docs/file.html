<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DocMind 文件管理</title>
    <link href="file.css" rel="stylesheet">
    <script>
        async function parseAndPreview(fileName) {
            const res = await fetch(`/api/parse?file_name=${encodeURIComponent(fileName)}`);
            const data = await res.json();
            window.open(data.markdown_preview_url, '_blank');
        }

        function downloadFile(fileName, type) {
            window.open(`/api/download?file_name=${encodeURIComponent(fileName)}&type=${type}`, '_blank');
        }

        function batchDownload(type) {
            const checked = document.querySelectorAll('.file-checkbox:checked');
            if (checked.length === 0) return alert('请先勾选文件');

            checked.forEach(cb => {
                const fileName = cb.dataset.filename;
                downloadFile(fileName, type);
            });
        }

        async function fetchFileList() {
            const res = await fetch('/api/files');
            const files = await res.json();
            const tbody = document.getElementById('fileTable');
            tbody.innerHTML = files.map(file => `
                <tr>
                    <td><input type="checkbox" class="file-checkbox" data-filename="${file.name}"></td>
                    <td>${file.name}</td>
                    <td><button onclick="window.open('${file.pdf_url}', '_blank')">预览PDF</button></td>
                    <td><button onclick="parseAndPreview('${file.name}')">预览Markdown</button></td>
                    <td><button onclick="downloadFile('${file.name}', 'pdf')">下载PDF</button></td>
                    <td><button onclick="downloadFile('${file.name}', 'md')">下载Markdown</button></td>
                </tr>
            `).join('');
        }

        async function handleUpload(e) {
            const files = e.target.files;
            if (!files.length) return;

            const formData = new FormData();
            Array.from(files).forEach(f => formData.append('files', f));

            await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            fetchFileList();
        }

        window.onload = fetchFileList;
    </script>
</head>

<body>
    <h1>DocMind 文件管理</h1>

    <input type="file" multiple onchange="handleUpload(event)">

    <table border="1">
        <thead>
            <tr>
                <th>选择</th>
                <th>文件名</th>
                <th>预览PDF</th>
                <th>预览Markdown</th>
                <th>下载PDF</th>
                <th>下载Markdown</th>
            </tr>
        </thead>
        <tbody id="fileTable"></tbody>
    </table>

    <button onclick="batchDownload('pdf')">批量下载PDF</button>
    <button onclick="batchDownload('md')">批量下载Markdown</button>
</body>

</html>
